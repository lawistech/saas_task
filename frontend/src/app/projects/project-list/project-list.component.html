<div class="project-table-wrapper">
  <!-- Loading State -->
  <app-loading-skeleton
    *ngIf="isLoading"
    type="table"
    [rows]="5">
  </app-loading-skeleton>

  <!-- Empty State -->
  <app-empty-state
    *ngIf="!isLoading && sortedProjects.length === 0"
    title="No projects found"
    [description]="searchTerm ? 'No projects match your search criteria. Try adjusting your filters.' : 'Get started by creating your first project to organize your work.'"
    icon="fas fa-folder-open"
    variant="projects"
    actionText="Create Project"
    actionIcon="fas fa-plus"
    (actionClick)="openAddProjectModal()">
  </app-empty-state>

  <!-- Table Content -->
  <div *ngIf="!isLoading && sortedProjects.length > 0" class="modern-table-container">
    <!-- Modern Table Controls -->
    <div class="table-controls">
      <div class="controls-left">
        <div *ngIf="selectedProjects.length > 0" class="selection-badge">
          <span class="selection-count">{{ selectedProjects.length }}</span>
          <span class="selection-text">selected</span>
          <button class="clear-selection" (click)="clearSelection()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="controls-right">
        <button class="control-btn" (click)="toggleColumnSettingsPanel()" title="Manage Columns">
          <i class="fas fa-columns"></i>
          <span>Columns</span>
        </button>
      </div>
    </div>

    <div *ngIf="showColumnSettingsPanel"
         class="absolute top-full right-0 mt-1 w-80 bg-white border border-gray-300 rounded-md shadow-lg z-10"> <!-- .column-settings-panel -->
      <div class="flex justify-between items-center py-2 px-4 border-b border-gray-200"> <!-- .panel-header -->
        <h3 class="text-lg font-medium text-gray-800 m-0">Configure Columns</h3>
        <button (click)="closeColumnSettingsPanel()" class="p-1 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-700"> <!-- .close-panel-btn -->
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <div class="p-4 max-h-96 overflow-y-auto"> <!-- .panel-content -->
        <div class="settings-group mb-4">
          <h4 class="text-md font-medium text-gray-800 mb-2">Visible Columns</h4>
          <p class="text-xs text-gray-500 mb-3">Drag to reorder. Uncheck to hide.</p>
          <div class="flex flex-col gap-2" cdkDropList (cdkDropListDropped)="onColumnDrop($event)"> <!-- .column-config-list -->
            <div *ngFor="let col of displayedColumnsConfig; let i = index" cdkDrag [cdkDragData]="col"
                 class="flex items-center p-2 rounded-md hover:bg-gray-50 cursor-grab"> <!-- .column-config-item -->
              <input type="checkbox" [checked]="col.visible" (change)="toggleColumnVisibility(col)"
                     class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2"> <!-- .column-visibility-toggle, .form-checkbox -->
              <label (click)="$event.stopPropagation()" class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer flex-grow"> <!-- .column-config-label -->
                <i class="fas fa-grip-vertical text-gray-400 text-md cursor-grab" cdkDragHandle></i> <!-- .drag-handle-icon -->
                {{ col.label || col.name }}
              </label>
            </div>
          </div>
        </div>
         <button (click)="openAddColumnModal()" class="w-full mt-2 py-2 px-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md text-sm font-medium flex items-center justify-center gap-2">
            <i class="fas fa-plus-circle"></i> Add Custom Column
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="showAddColumnModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 bg-white border border-gray-300 rounded-lg shadow-xl z-50"> <!-- .add-column-modal -->
    <div class="flex justify-between items-center py-2 px-4 border-b border-gray-200"> <!-- .modal-header -->
      <h3 class="text-lg font-medium text-gray-800 m-0">Add Custom Column</h3>
      <button (click)="closeAddColumnModal()" class="p-1 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-700"> <!-- .close-modal-btn -->
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
    <div class="p-4"> <!-- .modal-content -->
      <div class="form-group mb-4">
        <label for="newColumnName" class="block text-sm font-medium text-gray-700 mb-1">Column Name</label>
        <input id="newColumnName" type="text" [(ngModel)]="newColumn.name" placeholder="e.g., 'Client Name'"
               class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"> <!-- .form-input -->
      </div>
      <div class="form-group mb-4">
        <label for="newColumnType" class="block text-sm font-medium text-gray-700 mb-1">Data Type</label>
        <select id="newColumnType" [(ngModel)]="newColumn.type"
                class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"> <!-- .form-input (select) -->
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="date">Date</option>
        </select>
      </div>
      <div class="flex justify-end gap-3 mt-6"> <!-- .form-actions -->
        <button (click)="closeAddColumnModal()" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
        <button (click)="addColumn()" class="py-2 px-4 bg-gray-800 text-white rounded-md hover:bg-gray-900 text-sm font-medium">Add Column</button>
      </div>
    </div>
  </div>


    <!-- Modern Table -->
    <div class="table-wrapper">
      <table class="modern-table">
        <thead>
          <tr>
            <th class="checkbox-column">
              <div class="checkbox-container">
                <input type="checkbox"
                       (change)="toggleSelectAll($event)"
                       [checked]="allSelected"
                       class="modern-checkbox">
              </div>
            </th>
            <th *ngFor="let col of getVisibleColumns()"
                (click)="col.sortable ? sortData(col.key || col.id) : null"
                [ngClass]="{'sortable': col.sortable}"
                class="table-header">
              <div class="header-content">
                <span class="header-label">{{ col.label || col.name }}</span>
                <div class="sort-indicator" *ngIf="col.sortable">
                  <i class="fas fa-chevron-up"
                     [ngClass]="{'active': sortKey === (col.key || col.id) && sortDirection === 'asc'}"></i>
                  <i class="fas fa-chevron-down"
                     [ngClass]="{'active': sortKey === (col.key || col.id) && sortDirection === 'desc'}"></i>
                </div>
              </div>
            </th>
            <th class="actions-column">
              <span class="header-label">Actions</span>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let project of sortedProjects; trackBy: trackByProjectId"
              class="table-row"
              [ngClass]="{
                'selected': project.selected,
                'hovered': hoveredRowId === project.id
              }"
              (mouseenter)="onRowHover(project.id)"
              (mouseleave)="onRowHover(null)"
              (click)="viewProjectDetails(project, $event)"
              [attr.aria-label]="'Project: ' + project.name">

            <!-- Checkbox Column -->
            <td class="checkbox-cell">
              <div class="checkbox-container">
                <input
                  type="checkbox"
                  [(ngModel)]="project.selected"
                  (ngModelChange)="onRowSelect(project)"
                  (click)="$event.stopPropagation()"
                  class="modern-checkbox"
                  [attr.aria-label]="'Select project ' + project.name">
              </div>
            </td>

            <!-- Data Columns -->
            <td *ngFor="let col of getVisibleColumns()"
                class="table-cell"
                [ngClass]="{
                  'name-column': (col.key || col.id) === 'name',
                  'status-column': (col.key || col.id) === 'status',
                  'date-column': (col.key || col.id) === 'start_date' || (col.key || col.id) === 'end_date',
                  'budget-column': (col.key || col.id) === 'budget'
                }">

              <ng-container [ngSwitch]="col.key || col.id">
                <!-- Status Column -->
                <div *ngSwitchCase="'status'" class="status-cell">
                  <app-status-badge
                    [status]="getProjectValue(project, col)"
                    [editable]="true"
                    [loading]="isActionLoading('status', project.id)"
                    (statusChange)="onStatusChanged(project, $event)">
                  </app-status-badge>
                </div>

                <!-- Name Column -->
                <div *ngSwitchCase="'name'" class="name-cell">
                  <div class="project-info">
                    <div class="project-name"
                         (click)="viewProjectDetails(project, $event)"
                         [innerHTML]="highlightSearchTerm(project.name)">
                    </div>
                    <div class="project-meta" *ngIf="project.client_name">
                      {{ project.client_name }}
                    </div>
                  </div>
                </div>

                <!-- Budget Column -->
                <div *ngSwitchCase="'budget'" class="budget-cell">
                  <span class="budget-value">
                    {{ getProjectValue(project, col) !== null ? (getProjectValue(project, col) | currency:'USD':'symbol':'1.0-0') : '-' }}
                  </span>
                </div>

                <!-- Date Columns -->
                <div *ngSwitchCase="'start_date'" class="date-cell">
                  <span class="date-value">
                    {{ getProjectValue(project, col) ? (getProjectValue(project, col) | date:'MMM d, y') : '-' }}
                  </span>
                </div>

                <div *ngSwitchCase="'end_date'" class="date-cell">
                  <span class="date-value">
                    {{ getProjectValue(project, col) ? (getProjectValue(project, col) | date:'MMM d, y') : '-' }}
                  </span>
                </div>

                <!-- Description Column -->
                <div *ngSwitchCase="'description'" class="description-cell">
                  <span class="description-text" [title]="getProjectValue(project, col) || 'No description'">
                    {{ getProjectValue(project, col) || 'No description' }}
                  </span>
                </div>

                <!-- Default Column -->
                <span *ngSwitchDefault class="default-cell">{{ getProjectValue(project, col) || '-' }}</span>
              </ng-container>
            </td>

            <!-- Actions Column -->
            <td class="actions-cell">
              <div class="action-buttons" [ngClass]="{'visible': hoveredRowId === project.id}">
                <button class="action-btn view-btn"
                        (click)="viewProjectDetails(project, $event)"
                        title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit-btn"
                        (click)="onEditProjectWithLoading(project)"
                        title="Edit Project"
                        [disabled]="isActionLoading('edit', project.id)">
                  <i class="fas fa-edit" *ngIf="!isActionLoading('edit', project.id)"></i>
                  <i class="fas fa-spinner fa-spin" *ngIf="isActionLoading('edit', project.id)"></i>
                </button>
                <button class="action-btn delete-btn"
                        (click)="onDeleteProjectWithLoading(project.id)"
                        title="Delete Project"
                        [disabled]="isActionLoading('delete', project.id)">
                  <i class="fas fa-trash-alt" *ngIf="!isActionLoading('delete', project.id)"></i>
                  <i class="fas fa-spinner fa-spin" *ngIf="isActionLoading('delete', project.id)"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>

        <!-- Empty State -->
        <tbody *ngIf="!sortedProjects || sortedProjects.length === 0">
          <tr>
            <td [attr.colspan]="getVisibleColumns().length + 2" class="empty-row">
              <div class="empty-content">
                <i class="fas fa-folder-open"></i>
                <span>No projects to display</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
</div>
