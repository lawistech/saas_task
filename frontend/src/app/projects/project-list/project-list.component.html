<div class="project-table-wrapper"> <!-- Renamed for clarity -->
  <div class="table-controls-bar"> <!-- Renamed for clarity -->
    <!-- Apply .btn-secondary or similar for this button -->
    <button type="button" class="btn btn-secondary column-settings-trigger" (click)="toggleColumnSettings()">
      <span class="icon settings-icon">‚öôÔ∏è</span> Column Settings
    </button>

    <!-- Column Settings Dropdown / Modal -->
    <div class="column-settings-panel" *ngIf="showColumnSettings"> <!-- Renamed -->
      <header class="panel-header"> <!-- Changed to header -->
        <h3>Column Settings</h3>
        <!-- Apply .btn-icon or similar for close button -->
        <button type="button" class="btn btn-icon close-panel-btn" (click)="toggleColumnSettings()">‚úï</button>
      </header>

      <div class="panel-content">
        <div class="settings-group"> <!-- Renamed -->
          <h4>Visible Columns</h4>
          <p class="settings-description">Check columns to show/hide. Drag to reorder.</p>

          <div class="column-config-list"> <!-- Renamed -->
            <div *ngFor="let column of columns"
                 class="column-config-item" <!-- Renamed -->
                 draggable="true"
                 (dragstart)="onDragStart($event, column)"
                 (dragover)="onDragOver($event, column)"
                 (dragend)="onDragEnd()">

              <div class="column-visibility-toggle"> <!-- Renamed -->
                <input type="checkbox"
                       [id]="'col-' + column.id"
                       [checked]="column.visible"
                       (change)="toggleColumnVisibility(column)"
                       class="form-checkbox"> <!-- Add class for global styling -->
              </div>

              <label [for]="'col-' + column.id" class="column-config-label"> <!-- Renamed -->
                <span class="drag-handle-icon">‚ãÆ‚ãÆ</span> <!-- Renamed -->
                {{ column.name }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Column Form / Modal -->
  <div class="add-column-modal" *ngIf="showAddColumnForm"> <!-- Renamed -->
    <header class="modal-header"> <!-- Changed to header -->
      <h3>Add New Column</h3>
      <button type="button" class="btn btn-icon close-modal-btn" (click)="toggleAddColumnForm()">‚úï</button>
    </header>
    <div class="modal-content"> <!-- Renamed -->
      <div class="form-group">
        <label for="new-column-name">Column Name:</label> <!-- Changed id for uniqueness -->
        <input type="text" id="new-column-name" [(ngModel)]="newColumnName" placeholder="Enter column name" class="form-input"> <!-- Add class for global styling -->
      </div>
      <div class="form-actions">
        <!-- Apply .btn-secondary and .btn (primary) -->
        <button type="button" class="btn btn-secondary" (click)="toggleAddColumnForm()">Cancel</button>
        <button type="button" class="btn" (click)="addCustomColumn()">Add Column</button>
      </div>
    </div>
  </div>

  <div class="table-responsive-wrapper"> <!-- Wrapper for table overflow -->
    <table class="data-table project-data-table"> <!-- Renamed and added generic class -->
      <thead>
        <tr>
          <!-- Dynamically generate columns based on visibility and order -->
          <th *ngIf="isColumnVisible('checkbox')" class="col-checkbox">
            <input type="checkbox" (change)="toggleSelectAll($event)" class="form-checkbox">
          </th>

          <th *ngIf="isColumnVisible('name')" class="col-name sortable-header" (click)="sortProjects('name')">
            Project Name
            <span class="sort-indicator" *ngIf="sortField === 'name'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <th *ngIf="isColumnVisible('status')" class="col-status sortable-header" (click)="sortProjects('status')">
            Status
            <span class="sort-indicator" *ngIf="sortField === 'status'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <th *ngIf="isColumnVisible('client')" class="col-client sortable-header" (click)="sortProjects('client_name')">
            Client
            <span class="sort-indicator" *ngIf="sortField === 'client_name'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <th *ngIf="isColumnVisible('budget')" class="col-budget sortable-header" (click)="sortProjects('budget')">
            Budget
            <span class="sort-indicator" *ngIf="sortField === 'budget'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <th *ngIf="isColumnVisible('start_date')" class="col-date col-start-date sortable-header" (click)="sortProjects('start_date')">
            Start Date
            <span class="sort-indicator" *ngIf="sortField === 'start_date'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <th *ngIf="isColumnVisible('end_date')" class="col-date col-end-date sortable-header" (click)="sortProjects('end_date')">
            End Date
            <span class="sort-indicator" *ngIf="sortField === 'end_date'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>

          <!-- Custom columns -->
          <ng-container *ngFor="let column of getVisibleColumns()">
            <th *ngIf="column.id.startsWith('custom_')" class="col-custom">
              {{ column.name }}
            </th>
          </ng-container>

          <th *ngIf="isColumnVisible('actions')" class="col-actions">
            <!-- Apply .btn-icon -->
            <button type="button" class="btn btn-icon btn-add-column" (click)="toggleAddColumnForm()">+</button>
          </th>
        </tr>
      </thead>

      <tbody>
        <!-- Active Projects -->
        <tr class="table-group-header">
          <td [attr.colspan]="getVisibleColumnsCount()">Active Projects</td>
        </tr>

        <tr *ngFor="let project of getProjectsByStatus('active')"
            class="data-row project-data-row"
            [class.row-selected]="selectedProjects.includes(project.id)"
            (click)="toggleProjectDetails(project)">

          <td *ngIf="isColumnVisible('checkbox')" class="col-checkbox cell-checkbox" (click)="$event.stopPropagation()">
            <input type="checkbox"
                   [checked]="selectedProjects.includes(project.id)"
                   (change)="toggleProjectSelection(project, $event)"
                   class="form-checkbox">
          </td>

          <td *ngIf="isColumnVisible('name')" class="col-name cell-name">{{ project.name }}</td>

          <td *ngIf="isColumnVisible('status')" class="col-status cell-status">
            <span class="status-indicator" [ngClass]="getStatusClass(project.status)">
              {{ project.status === 'on_hold' ? 'On Hold' : (project.status.charAt(0).toUpperCase() + project.status.slice(1)) }}
            </span>
          </td>
          <td *ngIf="isColumnVisible('client')" class="col-client cell-client">{{ project.client_name || '-' }}</td>
          <td *ngIf="isColumnVisible('budget')" class="col-budget cell-budget">{{ formatCurrency(project.budget) }}</td>
          <td *ngIf="isColumnVisible('start_date')" class="col-date col-start-date cell-date">{{ formatDate(project.start_date) }}</td>
          <td *ngIf="isColumnVisible('end_date')" class="col-date col-end-date cell-date">{{ formatDate(project.end_date) }}</td>

          <ng-container *ngFor="let column of getVisibleColumns()">
            <td *ngIf="column.id.startsWith('custom_')" class="col-custom cell-custom">
              {{ project.custom_fields && project.custom_fields[column.id.replace('custom_', '')] || '-' }}
            </td>
          </ng-container>

          <td *ngIf="isColumnVisible('actions')" class="col-actions cell-actions" (click)="$event.stopPropagation()">
            <button type="button" class="btn btn-icon btn-view-details" (click)="viewProjectDetails(project, $event)" title="View Details">üëÅÔ∏è</button>
            <button type="button" class="btn btn-icon btn-edit" (click)="onEditProject(project, $event)" title="Edit Project">‚úèÔ∏è</button>
            <button type="button" class="btn btn-icon btn-delete" (click)="onDeleteProject(project.id, $event)" title="Delete Project">üóëÔ∏è</button>
          </td>
        </tr>

        <!-- On Hold Projects -->
        <tr class="table-group-header">
          <td [attr.colspan]="getVisibleColumnsCount()">On Hold Projects</td>
        </tr>
        <tr *ngFor="let project of getProjectsByStatus('on_hold')" class="data-row project-data-row" [class.row-selected]="selectedProjects.includes(project.id)" (click)="toggleProjectDetails(project)">
          <td *ngIf="isColumnVisible('checkbox')" class="col-checkbox cell-checkbox" (click)="$event.stopPropagation()"><input type="checkbox" [checked]="selectedProjects.includes(project.id)" (change)="toggleProjectSelection(project, $event)" class="form-checkbox"></td>
          <td *ngIf="isColumnVisible('name')" class="col-name cell-name">{{ project.name }}</td>
          <td *ngIf="isColumnVisible('status')" class="col-status cell-status"><span class="status-indicator" [ngClass]="getStatusClass(project.status)">{{ project.status === 'on_hold' ? 'On Hold' : (project.status.charAt(0).toUpperCase() + project.status.slice(1)) }}</span></td>
          <td *ngIf="isColumnVisible('client')" class="col-client cell-client">{{ project.client_name || '-' }}</td>
          <td *ngIf="isColumnVisible('budget')" class="col-budget cell-budget">{{ formatCurrency(project.budget) }}</td>
          <td *ngIf="isColumnVisible('start_date')" class="col-date col-start-date cell-date">{{ formatDate(project.start_date) }}</td>
          <td *ngIf="isColumnVisible('end_date')" class="col-date col-end-date cell-date">{{ formatDate(project.end_date) }}</td>
          <ng-container *ngFor="let column of getVisibleColumns()"><td *ngIf="column.id.startsWith('custom_')" class="col-custom cell-custom">{{ project.custom_fields && project.custom_fields[column.id.replace('custom_', '')] || '-' }}</td></ng-container>
          <td *ngIf="isColumnVisible('actions')" class="col-actions cell-actions" (click)="$event.stopPropagation()">
            <button type="button" class="btn btn-icon btn-view-details" (click)="viewProjectDetails(project, $event)" title="View Details">üëÅÔ∏è</button>
            <button type="button" class="btn btn-icon btn-edit" (click)="onEditProject(project, $event)" title="Edit Project">‚úèÔ∏è</button>
            <button type="button" class="btn btn-icon btn-delete" (click)="onDeleteProject(project.id, $event)" title="Delete Project">üóëÔ∏è</button>
          </td>
        </tr>

        <!-- Completed Projects -->
        <tr class="table-group-header">
          <td [attr.colspan]="getVisibleColumnsCount()">Completed Projects</td>
        </tr>
        <tr *ngFor="let project of getProjectsByStatus('completed')" class="data-row project-data-row" [class.row-selected]="selectedProjects.includes(project.id)" (click)="toggleProjectDetails(project)">
          <td *ngIf="isColumnVisible('checkbox')" class="col-checkbox cell-checkbox" (click)="$event.stopPropagation()"><input type="checkbox" [checked]="selectedProjects.includes(project.id)" (change)="toggleProjectSelection(project, $event)" class="form-checkbox"></td>
          <td *ngIf="isColumnVisible('name')" class="col-name cell-name">{{ project.name }}</td>
          <td *ngIf="isColumnVisible('status')" class="col-status cell-status"><span class="status-indicator" [ngClass]="getStatusClass(project.status)">{{ project.status === 'on_hold' ? 'On Hold' : (project.status.charAt(0).toUpperCase() + project.status.slice(1)) }}</span></td>
          <td *ngIf="isColumnVisible('client')" class="col-client cell-client">{{ project.client_name || '-' }}</td>
          <td *ngIf="isColumnVisible('budget')" class="col-budget cell-budget">{{ formatCurrency(project.budget) }}</td>
          <td *ngIf="isColumnVisible('start_date')" class="col-date col-start-date cell-date">{{ formatDate(project.start_date) }}</td>
          <td *ngIf="isColumnVisible('end_date')" class="col-date col-end-date cell-date">{{ formatDate(project.end_date) }}</td>
          <ng-container *ngFor="let column of getVisibleColumns()"><td *ngIf="column.id.startsWith('custom_')" class="col-custom cell-custom">{{ project.custom_fields && project.custom_fields[column.id.replace('custom_', '')] || '-' }}</td></ng-container>
          <td *ngIf="isColumnVisible('actions')" class="col-actions cell-actions" (click)="$event.stopPropagation()">
            <button type="button" class="btn btn-icon btn-view-details" (click)="viewProjectDetails(project, $event)" title="View Details">üëÅÔ∏è</button>
            <button type="button" class="btn btn-icon btn-edit" (click)="onEditProject(project, $event)" title="Edit Project">‚úèÔ∏è</button>
            <button type="button" class="btn btn-icon btn-delete" (click)="onDeleteProject(project.id, $event)" title="Delete Project">üóëÔ∏è</button>
          </td>
        </tr>

        <!-- Cancelled Projects -->
        <tr class="table-group-header">
          <td [attr.colspan]="getVisibleColumnsCount()">Cancelled Projects</td>
        </tr>
        <tr *ngFor="let project of getProjectsByStatus('cancelled')" class="data-row project-data-row" [class.row-selected]="selectedProjects.includes(project.id)" (click)="toggleProjectDetails(project)">
          <td *ngIf="isColumnVisible('checkbox')" class="col-checkbox cell-checkbox" (click)="$event.stopPropagation()"><input type="checkbox" [checked]="selectedProjects.includes(project.id)" (change)="toggleProjectSelection(project, $event)" class="form-checkbox"></td>
          <td *ngIf="isColumnVisible('name')" class="col-name cell-name">{{ project.name }}</td>
          <td *ngIf="isColumnVisible('status')" class="col-status cell-status"><span class="status-indicator" [ngClass]="getStatusClass(project.status)">{{ project.status === 'on_hold' ? 'On Hold' : (project.status.charAt(0).toUpperCase() + project.status.slice(1)) }}</span></td>
          <td *ngIf="isColumnVisible('client')" class="col-client cell-client">{{ project.client_name || '-' }}</td>
          <td *ngIf="isColumnVisible('budget')" class="col-budget cell-budget">{{ formatCurrency(project.budget) }}</td>
          <td *ngIf="isColumnVisible('start_date')" class="col-date col-start-date cell-date">{{ formatDate(project.start_date) }}</td>
          <td *ngIf="isColumnVisible('end_date')" class="col-date col-end-date cell-date">{{ formatDate(project.end_date) }}</td>
          <ng-container *ngFor="let column of getVisibleColumns()"><td *ngIf="column.id.startsWith('custom_')" class="col-custom cell-custom">{{ project.custom_fields && project.custom_fields[column.id.replace('custom_', '')] || '-' }}</td></ng-container>
          <td *ngIf="isColumnVisible('actions')" class="col-actions cell-actions" (click)="$event.stopPropagation()">
            <button type="button" class="btn btn-icon btn-view-details" (click)="viewProjectDetails(project, $event)" title="View Details">üëÅÔ∏è</button>
            <button type="button" class="btn btn-icon btn-edit" (click)="onEditProject(project, $event)" title="Edit Project">‚úèÔ∏è</button>
            <button type="button" class="btn btn-icon btn-delete" (click)="onDeleteProject(project.id, $event)" title="Delete Project">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
